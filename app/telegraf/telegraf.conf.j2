# Auto-generated by IIoT Edge Gateway
# Generated at: {{ generated_at }}
# DO NOT EDIT MANUALLY - changes will be overwritten

[agent]
  interval = "10s"
  round_interval = true
  flush_interval = "10s"
  hostname = "iiot-edge-gateway"

###############################################################################
#                            INPUT PLUGINS                                     #
###############################################################################

[[inputs.opcua]]
  name = "opcua"
  endpoint = "{{ opcua.endpoint }}"
  connect_timeout = "{{ opcua.connect_timeout }}"
  request_timeout = "{{ opcua.request_timeout }}"
  security_policy = "{{ opcua.security_policy }}"
  security_mode = "{{ opcua.security_mode }}"
  auth_method = "{{ opcua.auth_method }}"
{%- if opcua.auth_method == "UserName" %}
  username = "{{ opcua.username }}"
  password = "{{ opcua.password }}"
{%- endif %}
{%- if opcua.auth_method == "Certificate" and opcua.certificate %}
  certificate = "{{ opcua.certificate }}"
  private_key = "{{ opcua.private_key }}"
{%- endif %}
{%- if publishing.mode == "grouped" %}
  # Grouped mode: id tag excluded so the merge processor can combine all nodes
  tagexclude = ["id"]
{%- else %}
  optional_fields = ["DataType"]
{%- endif %}
{%- if publishing.mode == "grouped" %}

  # Message format: Grouped — nodes share sampling interval, merge processor
  # combines them into a single MQTT message per cycle
  [[inputs.opcua.group]]
    sampling_interval = "{{ publishing.group_interval }}"
{%- for node in nodes %}
    [[inputs.opcua.group.nodes]]
      name = "{{ node.name }}"
      namespace = "{{ node.namespace }}"
      identifier_type = "{{ node.identifier_type }}"
      identifier = "{{ node.identifier }}"
{%- endfor %}
{%- else %}

  # Message format: Individual — one MQTT message per node per cycle
{% for node in nodes %}
  [[inputs.opcua.nodes]]
    name = "{{ node.name }}"
    namespace = "{{ node.namespace }}"
    identifier_type = "{{ node.identifier_type }}"
    identifier = "{{ node.identifier }}"
{%- if node.get("sampling_mode") == "subscription" %}
    [inputs.opcua.nodes.monitoring_params]
      sampling_interval = "{{ node.get('interval', '1s') }}"
{%- if node.get("deadband_type", "None") != "None" %}
      deadband_type = "{{ node.deadband_type }}"
      deadband_value = {{ node.deadband_value }}
{%- endif %}
{%- endif %}
{% endfor %}
{%- endif %}
{%- if modbus.enabled and modbus.registers %}

[[inputs.modbus]]
  name = "modbus"
  controller = "{{ modbus.controller }}"
  transmission_mode = "TCP"
  slave_id = {{ modbus.slave_id }}
  timeout = "{{ modbus.timeout }}"

  [[inputs.modbus.metric]]
    name = "modbus"
    slave_id = {{ modbus.slave_id }}
{% for reg in modbus.registers %}
    [[inputs.modbus.metric.field]]
      name = "{{ reg.name }}"
      register = "{{ reg.register_type }}"
      address = {{ reg.address }}
      data_type = "{{ reg.data_type }}"
      byte_order = "{{ reg.byte_order }}"
{% endfor %}
{%- endif %}

# Internal metrics for self-monitoring
[[inputs.internal]]
  collect_memstats = true
{%- if publishing.mode == "grouped" %}

###############################################################################
#                            AGGREGATORS                                       #
###############################################################################

# Merge all opcua node metrics into a single message per flush cycle
[[aggregators.merge]]
  period = "{{ publishing.group_interval }}"
  namepass = ["opcua"]
  drop_original = true
{%- endif %}

###############################################################################
#                            OUTPUT PLUGINS                                    #
###############################################################################
{%- if mqtt.endpoint %}

[[outputs.mqtt]]
  servers = ["{{ mqtt.endpoint }}"]
  topic = '{{ mqtt.topic_pattern }}'
  qos = {{ mqtt.qos }}
  data_format = "{{ mqtt.data_format }}"
{%- if mqtt.username %}
  username = "{{ mqtt.username }}"
{%- endif %}
{%- if mqtt.password %}
  password = "{{ mqtt.password }}"
{%- endif %}
{%- if mqtt.tls_ca and ('mqtts://' in mqtt.endpoint or 'ssl://' in mqtt.endpoint) %}
  tls_ca = "{{ mqtt.tls_ca }}"
  tls_cert = "{{ mqtt.tls_cert }}"
  tls_key = "{{ mqtt.tls_key }}"
{%- endif %}
  namepass = [{% if modbus.enabled and modbus.registers %}"opcua", "modbus"{% else %}"opcua"{% endif %}]
{%- endif %}

# File output for internal metrics (read by gateway dashboard)
[[outputs.file]]
  files = ["/tmp/telegraf-metrics/metrics.json"]
  data_format = "json"
  rotation_max_size = "1MB"
  namepass = ["internal_*"]

# Health check endpoint
[[outputs.health]]
  service_address = "http://:8080"
