# Auto-generated by IIoT Edge Gateway
# Generated at: {{ generated_at }}
# DO NOT EDIT MANUALLY - changes will be overwritten

[agent]
  interval = "10s"
  round_interval = true
  flush_interval = "10s"
  hostname = "iiot-edge-gateway"

###############################################################################
#                            INPUT PLUGINS                                     #
###############################################################################

[[inputs.opcua]]
  name = "opcua"
  endpoint = "{{ opcua.endpoint }}"
  connect_timeout = "{{ opcua.connect_timeout }}"
  request_timeout = "{{ opcua.request_timeout }}"
  security_policy = "{{ opcua.security_policy }}"
  security_mode = "{{ opcua.security_mode }}"
  auth_method = "{{ opcua.auth_method }}"
{%- if opcua.auth_method == "UserName" %}
  username = "{{ opcua.username }}"
  password = "{{ opcua.password }}"
{%- endif %}
{%- if opcua.auth_method == "Certificate" and opcua.certificate %}
  certificate = "{{ opcua.certificate }}"
  private_key = "{{ opcua.private_key }}"
{%- endif %}
  optional_fields = ["DataType"]
{% for node in nodes %}
  [[inputs.opcua.nodes]]
    name = "{{ node.name }}"
    namespace = "{{ node.namespace }}"
    identifier_type = "{{ node.identifier_type }}"
    identifier = "{{ node.identifier }}"
{%- if node.get("sampling_mode") == "subscription" %}
    [inputs.opcua.nodes.monitoring_params]
      sampling_interval = "{{ node.get('interval', '1s') }}"
{%- if node.get("deadband_type", "None") != "None" %}
      deadband_type = "{{ node.deadband_type }}"
      deadband_value = {{ node.deadband_value }}
{%- endif %}
{%- endif %}
{% endfor %}
# Internal metrics for self-monitoring
[[inputs.internal]]
  collect_memstats = true

###############################################################################
#                            OUTPUT PLUGINS                                    #
###############################################################################
{%- if mqtt.endpoint %}

[[outputs.mqtt]]
  servers = ["{{ mqtt.endpoint }}"]
  topic = '{{ mqtt.topic_pattern }}'
  qos = {{ mqtt.qos }}
  data_format = "{{ mqtt.data_format }}"
{%- if mqtt.tls_ca %}
  tls_ca = "{{ mqtt.tls_ca }}"
  tls_cert = "{{ mqtt.tls_cert }}"
  tls_key = "{{ mqtt.tls_key }}"
{%- endif %}
  [outputs.mqtt.tagpass]
    input = ["opcua"]
{%- endif %}

# File output for internal metrics (read by gateway dashboard)
[[outputs.file]]
  files = ["/tmp/telegraf-metrics/metrics.json"]
  data_format = "json"
  rotation_max_size = "1MB"
  namepass = ["internal_*"]

# Health check endpoint
[[outputs.health]]
  service_address = "http://:8080"
