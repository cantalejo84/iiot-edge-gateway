{% extends "base.html" %}

{% block page_title %}Dashboard{% endblock %}

{% block content %}

{% if never_deployed %}
<div class="first-deploy-banner mb-4">
    <div class="first-deploy-icon"><i class="bi bi-rocket-takeoff"></i></div>
    <div class="first-deploy-body">
        <div class="first-deploy-title">Welcome — gateway not yet configured</div>
        <div class="first-deploy-desc">
            Configure your <a href="/opcua/config" class="first-deploy-link">OPC UA input</a>
            and <a href="/mqtt/config" class="first-deploy-link">MQTT output</a>,
            then click <strong>Deploy config</strong> in the sidebar to start the data pipeline.
            Telegraf is running and waiting for the first configuration.
        </div>
    </div>
    <button class="btn btn-apply first-deploy-btn" id="btn-apply-banner" data-action="generate-config">
        <i class="bi bi-cloud-upload"></i> Deploy config
    </button>
</div>
{% endif %}

<!-- Pipeline Health -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-activity"></i> Pipeline Health</span>
        <span class="pipeline-status-badge" id="pipeline-status-badge">
            <span class="pipeline-status-dot" id="pipeline-status-dot"></span>
            <span id="pipeline-status-label">Checking...</span>
        </span>
    </div>
    <div class="card-body">
        {% set has_opcua = opcua_ready %}
        {% set has_modbus = modbus_ready %}
        {% set dual = has_opcua and has_modbus %}

        <div class="pipeline-flow-v2 {% if dual %}pipeline-dual{% endif %}" id="pipeline-flow">

            <!-- Input nodes column -->
            <div class="pf-inputs-col">

                {% if has_opcua or not has_modbus %}
                <!-- OPC UA node -->
                <div class="pf-node pf-node-opcua" id="pf-opcua">
                    <div class="pf-pulse-ring"></div>
                    <div class="pf-node-icon"><i class="bi bi-cpu"></i></div>
                    <div class="pf-node-label">OPC UA Read</div>
                    <div class="pf-node-value" id="p-opcua-read">--</div>
                    <div class="pf-quality-row">
                        <span class="pf-quality-chip pf-q-ok" data-bs-toggle="tooltip" title="Successful node reads">
                            <i class="bi bi-check-lg"></i> <span id="q-read-success">--</span>
                        </span>
                        <span class="pf-quality-chip pf-q-err" data-bs-toggle="tooltip" title="Failed node reads">
                            <i class="bi bi-x-lg"></i> <span id="q-read-error">--</span>
                        </span>
                        <span class="pf-quality-chip pf-q-rate" data-bs-toggle="tooltip" title="Read success rate">
                            <span id="q-success-rate">--</span>
                        </span>
                        <div class="pf-quality-bar">
                            <div class="pf-quality-bar-fill" id="q-success-bar"></div>
                            <div class="pf-quality-bar-err" id="q-error-bar"></div>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if has_modbus %}
                <!-- Modbus node -->
                <div class="pf-node pf-node-modbus" id="pf-modbus">
                    <div class="pf-pulse-ring"></div>
                    <div class="pf-node-icon"><i class="bi bi-ethernet"></i></div>
                    <div class="pf-node-label">Modbus Read</div>
                    <div class="pf-node-value" id="p-modbus-read">--</div>
                    <div class="pf-quality-row">
                        <span class="pf-quality-chip pf-q-err" data-bs-toggle="tooltip" title="Modbus read errors">
                            <i class="bi bi-x-lg"></i> <span id="p-modbus-errors">--</span>
                        </span>
                        <span class="pf-quality-chip pf-q-ok" data-bs-toggle="tooltip" title="Modbus scan time">
                            <i class="bi bi-clock"></i> <span id="p-modbus-scan">-- ms</span>
                        </span>
                    </div>
                </div>
                {% endif %}

            </div>

            <!-- Connector 1 (fork when dual) -->
            <div class="pf-connector {% if dual %}pf-connector-fork{% endif %}">
                <div class="pf-connector-line"></div>
                <div class="pf-connector-x"><i class="bi bi-x"></i></div>
                <div class="flow-dot"></div>
                <div class="flow-dot"></div>
                <div class="flow-dot"></div>
            </div>

            <!-- Buffer -->
            <div class="pf-node pf-node-buffer">
                <div class="pf-node-label">Buffer</div>
                <div class="pf-buffer-bar">
                    <div class="pf-buffer-fill" id="p-buffer-fill" style="width:0%"></div>
                </div>
                <div class="pf-node-sub" id="p-buffer-text">0 / 10,000</div>
            </div>

            <!-- Connector 2 -->
            <div class="pf-connector">
                <div class="pf-connector-line"></div>
                <div class="pf-connector-x"><i class="bi bi-x"></i></div>
                <div class="flow-dot"></div>
                <div class="flow-dot"></div>
                <div class="flow-dot"></div>
            </div>

            <!-- MQTT Send -->
            <div class="pf-node pf-node-mqtt">
                <div class="pf-node-icon"><i class="bi bi-cloud-arrow-up"></i></div>
                <div class="pf-node-label">MQTT Send</div>
                <div class="pf-node-value" id="p-mqtt-written">--</div>
            </div>
        </div>

        <!-- Stats row -->
        <div class="dash-grid dash-grid-4 mt-3">
            {% if has_opcua or not has_modbus %}
            <div class="pipeline-stat">
                <div class="pipeline-stat-value" id="p-scan-time">--</div>
                <div class="pipeline-stat-label">
                    OPC UA Scan
                    <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Time Telegraf takes to read all OPC UA nodes per cycle."></i>
                </div>
            </div>
            {% endif %}
            {% if has_modbus %}
            <div class="pipeline-stat">
                <div class="pipeline-stat-value" id="p-modbus-scan-stat">--</div>
                <div class="pipeline-stat-label">
                    Modbus Scan
                    <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Time Telegraf takes to poll all Modbus registers per cycle."></i>
                </div>
            </div>
            {% endif %}
            <div class="pipeline-stat">
                <div class="pipeline-stat-value" id="p-dropped">--</div>
                <div class="pipeline-stat-label">
                    Dropped
                    <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Messages discarded because the MQTT output buffer was full."></i>
                </div>
            </div>
            <div class="pipeline-stat">
                <div class="pipeline-stat-value" id="p-errors">--</div>
                <div class="pipeline-stat-label">
                    Errors (In / MQTT)
                    <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Input read errors (OPC UA + Modbus combined) / MQTT write errors."></i>
                </div>
            </div>
            <div class="pipeline-stat">
                <div class="pipeline-stat-value" id="p-loss">--</div>
                <div class="pipeline-stat-label">
                    Loss Rate
                    <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Percentage of collected metrics that did not reach MQTT. Should be 0%."></i>
                </div>
            </div>
        </div>

        <!-- Data quality (OPC UA only) -->
        {% if has_opcua or not has_modbus %}
        <div class="dash-grid dash-grid-4 mt-2">
            <div class="quality-stat">
                <div class="quality-stat-value text-success" id="q2-read-success">--</div>
                <div class="quality-stat-label">OPC UA OK reads</div>
            </div>
            <div class="quality-stat">
                <div class="quality-stat-value text-danger" id="q2-read-error">--</div>
                <div class="quality-stat-label">OPC UA read errors</div>
            </div>
            <div class="quality-stat col-span-2">
                <div class="pf-quality-bar" style="height:6px;border-radius:3px;">
                    <div class="pf-quality-bar-fill" id="q2-success-bar"></div>
                    <div class="pf-quality-bar-err" id="q2-error-bar"></div>
                </div>
                <div class="quality-stat-label mt-1">Success rate: <strong id="q2-success-rate">--</strong></div>
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- System Health + Gateway Info -->
<div class="row g-4 mb-4">

    <!-- System Health -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-cpu"></i> System Health</div>
            <div class="card-body">
                <div class="dash-grid dash-grid-2">
                    <div class="hw-metric">
                        <div class="hw-metric-header">
                            <span class="hw-metric-label">CPU</span>
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Processor usage of the gateway host."></i>
                        </div>
                        <div class="hw-metric-value" id="cpu-value">--</div>
                        <div class="progress mt-1">
                            <div class="progress-bar" id="cpu-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="hw-metric">
                        <div class="hw-metric-header">
                            <span class="hw-metric-label">Memory</span>
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="RAM usage. If MQTT broker is unreachable, Telegraf's buffer grows and RAM increases."></i>
                        </div>
                        <div class="hw-metric-value" id="ram-value">--</div>
                        <div class="progress mt-1">
                            <div class="progress-bar" id="ram-bar" style="width:0%"></div>
                        </div>
                        <div class="hw-metric-detail" id="ram-detail"></div>
                    </div>
                    <div class="hw-metric">
                        <div class="hw-metric-header">
                            <span class="hw-metric-label">Disk</span>
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Disk space used on the gateway. Full disk can crash the gateway."></i>
                        </div>
                        <div class="hw-metric-value" id="disk-value">--</div>
                        <div class="progress mt-1">
                            <div class="progress-bar" id="disk-bar" style="width:0%"></div>
                        </div>
                    </div>
                    <div class="hw-metric">
                        <div class="hw-metric-header">
                            <span class="hw-metric-label">Network I/O</span>
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Total bytes sent and received since boot."></i>
                        </div>
                        <div class="hw-metric-net">
                            <div><i class="bi bi-arrow-up"></i> <span id="net-sent">--</span></div>
                            <div><i class="bi bi-arrow-down"></i> <span id="net-recv">--</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Gateway Info -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header"><i class="bi bi-info-circle"></i> Gateway Info</div>
            <div class="card-body d-flex flex-column gap-3">

                <!-- Components -->
                <div>
                    <div class="gw-section-label">
                        Components
                        <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Status of all gateway components."></i>
                    </div>
                    <div class="container-status-list" id="g-containers">
                        <span class="text-muted" style="font-size:0.75rem;">Checking...</span>
                    </div>
                </div>

                <!-- Metrics -->
                <div class="gw-meta-row">
                    <div class="gw-meta-item">
                        <div class="gw-meta-label">
                            Online for
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="Time since the gateway container was last started."></i>
                        </div>
                        <div class="gw-meta-value" id="g-uptime">--</div>
                    </div>
                    <div class="gw-meta-item">
                        <div class="gw-meta-label">
                            Nodes configured
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="OPC UA nodes selected for data collection."></i>
                        </div>
                        <div class="gw-meta-value" id="g-nodes">--</div>
                    </div>
                    <div class="gw-meta-item">
                        <div class="gw-meta-label">
                            Last config applied
                            <i class="bi bi-info-circle hint-icon" data-bs-toggle="tooltip" title="When the Telegraf configuration was last generated and applied."></i>
                        </div>
                        <div class="gw-meta-value" id="g-last-config">--</div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<div class="text-center mb-3" style="font-family:var(--font-mono);font-size:0.65rem;color:var(--text-muted);">
    Auto-refresh every 5s · Counters since last Telegraf restart · Updated: <span id="last-updated">--</span>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
