{% extends "base.html" %}

{% block page_title %}MQTT Output Configuration{% endblock %}

{% block header_actions %}{% endblock %}

{% block content %}
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>AWS IoT Core / MQTT Broker</span>
                <button class="btn btn-sm btn-outline-secondary" id="btn-use-demo" title="Auto-fill with built-in Mosquitto broker">
                    <i class="bi bi-lightning"></i> Use Demo Broker
                </button>
            </div>
            <div class="card-body p-3">
                <div class="mb-3">
                    <label class="form-label">Endpoint URL</label>
                    <input type="text" class="form-control" id="endpoint" value="{{ config.endpoint }}" placeholder="mqtts://xxxx-ats.iot.eu-west-1.amazonaws.com:8883">
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Topic Pattern</label>
                        <input type="text" class="form-control" id="topic_pattern" value="{{ config.topic_pattern }}" placeholder='iiot/gateway/{{ "{{ .Hostname }}" }}/{{ "{{ .PluginName }}" }}'>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">QoS</label>
                        <select class="form-select" id="qos">
                            <option value="0" {% if config.qos == 0 %}selected{% endif %}>0 - At most once</option>
                            <option value="1" {% if config.qos == 1 %}selected{% endif %}>1 - At least once</option>
                            <option value="2" {% if config.qos == 2 %}selected{% endif %}>2 - Exactly once</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Data Format</label>
                        <select class="form-select" id="data_format">
                            <option value="json" {% if config.data_format == 'json' %}selected{% endif %}>JSON</option>
                            <option value="influx" {% if config.data_format == 'influx' %}selected{% endif %}>InfluxDB Line</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Certificates -->
        <div class="card mt-4">
            <div class="card-header">TLS Certificates</div>
            <div class="card-body p-3">
                <p class="text-secondary mb-3" style="font-size: 0.8rem;">
                    Upload certificates for TLS authentication (required for AWS IoT Core).
                </p>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">CA Certificate</label>
                        <input type="file" class="form-control" id="tls_ca" accept=".pem,.crt">
                        <div class="cert-status mt-1 {{ 'uploaded' if certs_status.tls_ca else 'missing' }}">
                            <i class="bi bi-{{ 'check-circle-fill' if certs_status.tls_ca else 'circle' }}"></i>
                            {{ 'ca.pem uploaded' if certs_status.tls_ca else 'Not uploaded' }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Client Certificate</label>
                        <input type="file" class="form-control" id="tls_cert" accept=".pem,.crt">
                        <div class="cert-status mt-1 {{ 'uploaded' if certs_status.tls_cert else 'missing' }}">
                            <i class="bi bi-{{ 'check-circle-fill' if certs_status.tls_cert else 'circle' }}"></i>
                            {{ 'cert.pem uploaded' if certs_status.tls_cert else 'Not uploaded' }}
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Private Key</label>
                        <input type="file" class="form-control" id="tls_key" accept=".pem,.key">
                        <div class="cert-status mt-1 {{ 'uploaded' if certs_status.tls_key else 'missing' }}">
                            <i class="bi bi-{{ 'check-circle-fill' if certs_status.tls_key else 'circle' }}"></i>
                            {{ 'key.pem uploaded' if certs_status.tls_key else 'Not uploaded' }}
                        </div>
                    </div>
                </div>
                <button class="btn btn-outline-secondary mt-3" id="btn-upload-certs">
                    <i class="bi bi-upload"></i> Upload Certificates
                </button>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">Connection Test</div>
            <div class="card-body p-3">
                <p class="text-secondary" style="font-size: 0.8rem;">
                    Test MQTT broker connection with current settings and certificates.
                </p>
                <button class="btn btn-outline-secondary w-100" id="btn-test">
                    <i class="bi bi-plug"></i> Test Connection
                </button>
                <div id="test-result" class="test-result"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/mqtt_config.js') }}"></script>
{% endblock %}
